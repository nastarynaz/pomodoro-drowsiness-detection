<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Drowsiness Detection System</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="{{ url_for('static', filename='css/style.css') }}"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <header class="header">
        <div class="header-content">
          <div class="logo">
            <i class="fas fa-eye"></i>
            <h1>Pomodoro Drowsiness Detection</h1>
          </div>
          <div class="status-indicator">
            <div class="status-circle" id="statusCircle"></div>
            <span id="statusText">Ready</span>
          </div>
        </div>
      </header>

      <!-- Pomodoro Section -->
      <section
        class="pomodoro-panel"
        style="margin-bottom: 30px; width: 100%; grid-column: 1/-1"
      >
        <div
          class="pomodoro-header"
          style="display: flex; align-items: center; gap: 10px"
        >
          <i class="fas fa-clock" style="font-size: 1.5rem; color: #2563eb"></i>
          <h2 style="margin: 0; color: #2563eb">Pomodoro Session</h2>
        </div>
        <div
          class="pomodoro-content"
          style="
            display: flex;
            align-items: center;
            margin-top: 15px;
            width: 100%;
          "
        >
          <div
            class="pomodoro-timer"
            style="
              background: #fff;
              border-radius: 12px;
              box-shadow: 0 4px 6px rgba(0, 0, 0, 0.08);
              padding: 40px 0;
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              width: 100%;
            "
          >
            <div
              id="pomodoroTime"
              style="
                font-size: 3rem;
                font-weight: 700;
                color: #2563eb;
                text-align: center;
              "
            >
              25:00
            </div>
            <div
              id="pomodoroStatus"
              style="
                font-size: 1.2rem;
                color: #64748b;
                text-align: center;
                margin-top: 10px;
              "
            >
              Study
            </div>
            <div
              style="
                display: flex;
                justify-content: center;
                gap: 20px;
                margin-top: 30px;
              "
            >
              <button id="pomodoroStartBtn" class="btn btn-success">
                <i class="fas fa-play"></i> Start
              </button>
              <button id="pomodoroStopBtn" class="btn btn-danger" disabled>
                <i class="fas fa-stop"></i> Stop
              </button>
              <button id="pomodoroResetBtn" class="btn btn-info">
                <i class="fas fa-redo"></i> Reset
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Control Panel -->
        <div class="control-panel">
          <h2><i class="fas fa-sliders-h"></i> Control Panel</h2>
          <div class="controls">
            <label
              for="cameraSelect"
              style="margin-right: 10px; font-weight: 500; color: #2563eb"
            >
              <i class="fas fa-camera"></i> Camera:
            </label>
            <select
              id="cameraSelect"
              style="
                margin-right: 20px;
                padding: 5px 10px;
                border-radius: 6px;
                border: 1px solid #2563eb;
              "
            >
              <option value="0">Camera 0 (Default)</option>
              <option value="1">Camera 1</option>
              <option value="2">Camera 2</option>
            </select>
            <button id="startBtn" class="btn btn-success">
              <i class="fas fa-play"></i> Start Detection
            </button>
            <button id="stopBtn" class="btn btn-danger" disabled>
              <i class="fas fa-stop"></i> Stop Detection
            </button>
            <button id="uploadBtn" class="btn btn-info">
              <i class="fas fa-upload"></i> Upload Image
            </button>
            <input
              type="file"
              id="imageUpload"
              accept="image/*"
              style="display: none"
            />
          </div>
        </div>

        <!-- Video Display -->
        <div class="video-container">
          <div class="video-wrapper">
            <img id="videoFeed" src="" alt="Video Feed" style="display: none" />
            <div
              id="uploadPreview"
              class="upload-preview"
              style="display: none"
            >
              <img id="uploadedImage" src="" alt="Uploaded Image" />
            </div>
            <div id="placeholder" class="video-placeholder">
              <i class="fas fa-video"></i>
              <p>Click "Start Detection" to begin webcam monitoring</p>
              <p>or "Upload Image" to analyze a photo</p>
            </div>
          </div>

          <!-- Status Panel -->
          <div class="status-panel">
            <div class="status-item">
              <label>Detection Status:</label>
              <span id="detectionStatus" class="status-value">Stopped</span>
            </div>
            <div class="status-item">
              <label>Confidence Level:</label>
              <span id="confidenceLevel" class="status-value">0%</span>
            </div>
            <div class="status-item">
              <label>Current State:</label>
              <span id="currentState" class="status-value">Ready</span>
            </div>
          </div>
        </div>

        <!-- Statistics Panel -->
        <div class="stats-panel">
          <h3><i class="fas fa-chart-bar"></i> Detection Statistics</h3>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon">
                <i class="fas fa-clock"></i>
              </div>
              <div class="stat-info">
                <span class="stat-value" id="sessionTime">00:00</span>
                <span class="stat-label">Session Time</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">
                <i class="fas fa-exclamation-triangle"></i>
              </div>
              <div class="stat-info">
                <span class="stat-value" id="drowsinessCount">0</span>
                <span class="stat-label">Drowsiness Alerts</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">
                <i class="fas fa-percentage"></i>
              </div>
              <div class="stat-info">
                <span class="stat-value" id="avgConfidence">0%</span>
                <span class="stat-label">Avg Confidence</span>
              </div>
            </div>
          </div>
        </div>
      </main>

      <!-- Alert Modal -->
      <div id="alertModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Drowsiness Alert!</h3>
          </div>
          <div class="modal-body">
            <p>Drowsiness detected! Please focused.</p>
          </div>
          <div class="modal-footer">
            <button id="closeAlert" class="btn btn-primary">
              I will focus from now
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script>
      // Pomodoro Timer Logic
      document.addEventListener("DOMContentLoaded", function () {
        let pomodoroTime = 25 * 60;
        let pomodoroRest = 5 * 60;
        let timer = pomodoroTime;
        let interval = null;
        let isStudy = true;
        const timeDisplay = document.getElementById("pomodoroTime");
        const statusDisplay = document.getElementById("pomodoroStatus");
        const startBtn = document.getElementById("pomodoroStartBtn");
        const stopBtn = document.getElementById("pomodoroStopBtn");
        const resetBtn = document.getElementById("pomodoroResetBtn");

        function updateDisplay() {
          const min = Math.floor(timer / 60)
            .toString()
            .padStart(2, "0");
          const sec = (timer % 60).toString().padStart(2, "0");
          timeDisplay.textContent = `${min}:${sec}`;
          statusDisplay.textContent = isStudy ? "Study" : "Rest";
          statusDisplay.style.color = isStudy ? "#2563eb" : "#10b981";
        }

        function startTimer() {
          if (interval) return;
          interval = setInterval(() => {
            timer--;
            updateDisplay();
            if (timer <= 0) {
              clearInterval(interval);
              interval = null;
              isStudy = !isStudy;
              timer = isStudy ? pomodoroTime : pomodoroRest;
              updateDisplay();
              // Optional: play sound or show notification
              startTimer();
            }
          }, 1000);
          startBtn.disabled = true;
          stopBtn.disabled = false;
        }

        function stopTimer() {
          if (interval) {
            clearInterval(interval);
            interval = null;
            startBtn.disabled = false;
            stopBtn.disabled = true;
          }
        }

        function resetTimer() {
          stopTimer();
          isStudy = true;
          timer = pomodoroTime;
          updateDisplay();
        }

        updateDisplay();
        if (startBtn) startBtn.addEventListener("click", startTimer);
        if (stopBtn) stopBtn.addEventListener("click", stopTimer);
        if (resetBtn) resetBtn.addEventListener("click", resetTimer);
      });
    </script>
    <script>
      // Video feed display logic
      document.addEventListener("DOMContentLoaded", function () {
        const startBtn = document.getElementById("startBtn");
        const stopBtn = document.getElementById("stopBtn");
        const videoFeed = document.getElementById("videoFeed");
        const placeholder = document.getElementById("placeholder");
        const cameraSelect = document.getElementById("cameraSelect");

        let currentCameraIdx = 0;

        function showVideoFeed(cameraIdx) {
          videoFeed.src = `/video_feed?camera=${cameraIdx}`;
          videoFeed.style.display = "block";
          placeholder.style.display = "none";
        }
        function hideVideoFeed() {
          videoFeed.src = "";
          videoFeed.style.display = "none";
          placeholder.style.display = "flex";
        }

        if (startBtn) {
          startBtn.addEventListener("click", function (e) {
            e.preventDefault();
            const idx = cameraSelect ? cameraSelect.value : 0;
            currentCameraIdx = idx;
            fetch(`/start_detection?camera=${idx}`, { method: "POST" })
              .then((res) => res.json())
              .then((data) => {
                showVideoFeed(idx);
                startBtn.disabled = true;
                stopBtn.disabled = false;
              });
          });
        }
        if (stopBtn) {
          stopBtn.addEventListener("click", function (e) {
            e.preventDefault();
            fetch(`/stop_detection`, { method: "POST" })
              .then((res) => res.json())
              .then((data) => {
                hideVideoFeed();
                startBtn.disabled = false;
                stopBtn.disabled = true;
              });
          });
        }
        if (cameraSelect) {
          cameraSelect.addEventListener("change", function (e) {
            if (startBtn.disabled) {
              // If detection is running, restart with new camera
              fetch(`/stop_detection`, { method: "POST" }).then(() => {
                const idx = cameraSelect.value;
                currentCameraIdx = idx;
                fetch(`/start_detection?camera=${idx}`, { method: "POST" })
                  .then((res) => res.json())
                  .then((data) => {
                    showVideoFeed(idx);
                  });
              });
            }
          });
        }
      });
    </script>
  </body>
</html>
